<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>税務調査アドベンチャー</title>
    <!-- スタイルシート -->
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=M+PLUS+1p:wght@400&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Press Start 2P', 'M PLUS 1p', sans-serif;
            background-color: #000;
            color: #33FF33;
            text-align: center;
            margin: 0;
            height: 100vh;
            overflow: hidden;
        }
        .game-container {
            display: flex;
            height: 100%;
        }
        .data-display {
            flex: 1;
            background-color: #222;
            padding: 20px;
            color: #FFCC33;
            font-size: 18px;
            overflow-y: auto;
        }
        .game-content {
            flex: 2;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 20px;
            color: #33FF33;
        }
        .scene-image img {
            width: 100%;
            height: auto;
            max-height: 400px;
            object-fit: contain;
            border: 2px solid #33FF33;
            margin-bottom: 10px;
        }
        .status-bar {
            display: flex;
            justify-content: space-around;
            margin-bottom: 10px;
            color: #FFCC33;
            font-size: 18px;
        }
        .text-box {
            background-color: #111;
            color: #FFF;
            padding: 15px;
            border: 2px solid #33FF33;
            margin-bottom: 15px;
            font-size: 18px;
            text-align: left;
            line-height: 1.6;
            flex-grow: 1;
            overflow-y: auto;
        }
        .choices .choice {
            padding: 8px;
            margin: 5px 0;
            background-color: #444;
            color: #FFF;
            border: 1px solid #33FF33;
            cursor: pointer;
            font-size: 18px;
        }
        .choices .choice:hover {
            background-color: #555;
        }
        #csvFileInput {
            display: none;
        }
        .upload-label {
            color: #FFCC33;
            cursor: pointer;
            font-size: 18px;
            display: inline-block;
            margin-bottom: 10px;
        }
        .play-again-button {
            margin-top: 20px;
            padding: 10px 20px;
            background-color: #33FF33;
            color: #000;
            font-size: 18px;
            border: none;
            cursor: pointer;
        }
        .play-again-button:hover {
            background-color: #28cc28;
        }
    </style>
</head>
<body>
    <div class="game-container">
        <div class="data-display" id="dataDisplay">
            <h2>読み込んだデータ:</h2>
            <label for="csvFileInput" class="upload-label">CSVファイルをアップロード</label>
            <input type="file" id="csvFileInput" accept=".csv">
            <div id="dataDetails"></div>
        </div>

        <div class="game-content">
            <div class="scene-image" id="sceneImage">
                <img src="office.png" alt="scene">
            </div>

            <div class="status-bar">
                <div>信頼度: <span id="trustValue">50</span></div>
                <div>ストレス: <span id="stressValue">0</span></div>
            </div>

            <div class="text-box">
                <div class="text-content" id="textContent"></div>
            </div>

            <div class="choices" id="choices"></div>
        </div>
    </div>

    <script>
        class RetroGame {
            constructor() {
                this.initialState = {
                    trust: 50,
                    stress: 0,
                    documents: [],
                    textSpeed: 30,
                    currentScene: '',
                    currentDocumentIndex: 0,
                };
                this.state = { ...this.initialState };

                this.scenes = {
                    intro: {
                        text: "20XX年、あなたの会社に税務調査の通知が届いた。\n調査官は以下の書類について詳しく確認したいようだ: {documents}\n準備を進めましょう。",
                        image: "office.png",
                        next: 'preparation',
                    },
                    preparation: {
                        text: "税務調査の準備を始めます。\nまずは書類を整理し、質問に備えましょう。",
                        image: "office.png",
                        choices: [
                            { text: "迅速に準備を進める", next: 'greeting', trust: 5 },
                            { text: "後回しにする", next: 'badEnd', trust: -20 },
                        ]
                    },
                    greeting: {
                        text: "税務調査官が訪問しました。\n調査官: 『おはようございます。本日はよろしくお願いいたします。』",
                        image: "appriciation.png",
                        choices: [
                            { text: "よろしくお願いします。", next: 'documentReview', trust: 5 },
                            { text: "・・・", next: 'documentReview', trust: -5 },
                        ]
                    },
                    documentReview: {
                        text: "{currentItem} の金額は {currentAmount} 円です。\n調査官からの質問にどう答えますか？",
                        image: "documents.png",
                        choices: [
                            { text: "詳細に説明する", next: 'investigation', trust: 5 },
                            { text: "簡潔に答える", next: 'investigation', trust: 0 },
                            { text: "不明瞭な回答をする", next: 'investigation', trust: -5 },
                        ]
                    },
                    investigation: {
                        text: "調査官がさらに詳細な情報を求めています。\nどのように対応しますか？",
                        image: "officer.png",
                        choices: [
                            { text: "全ての情報を提供する", next: 'deskRequest', trust: 5 },
                            { text: "一部の情報だけ提供する", next: 'deskRequest', trust: -5 },
                            { text: "情報提供を拒否する", next: 'badEnd', trust: -20 },
                        ]
                    },
                    deskRequest: {
                        text: "調査官: 『机の中を見せていただけますか？』",
                        image: "desk.png",
                        choices: [
                            { text: "いやです。", next: 'deskInsist', trust: -5 },
                            { text: "どうぞご覧ください。", next: 'deskAccept', trust: 5 },
                        ]
                    },
                    deskInsist: {
                        text: "調査官: 『何か隠しているのですか？』\n調査官が疑いの目を向けています。",
                        image: "desk.png",
                        choices: [
                            { text: "やっぱり見せます。", next: 'deskAccept', trust: -5 },
                            { text: "見せるわけにはいきません。", next: 'badEnd', trust: -20 },
                        ]
                    },
                    deskAccept: {
                        text: "調査官は机の中を調べましたが、特に問題はなさそうです。",
                        image: "officer.png",
                        next: 'nextDocument',
                    },
                    nextDocument: {
                        text: "",
                        next: 'checkNextDocument',
                    },
                    end: {
                        text: "税務調査が終了しました。\n最終的な信頼度は {trust} です。\n結果に応じて評価が決まります。",
                        image: "office.png",
                        choices: [
                            { text: "もう一度遊ぶ", action: 'resetGame' }
                        ]
                    },
                    badEnd: {
                        text: "調査官の疑いが深まり、思わぬ問題が発生しました。\nゲームオーバー。",
                        image: "point.png",
                        choices: [
                            { text: "もう一度遊ぶ", action: 'resetGame' }
                        ]
                    }
                };

                this.init();
            }

            init() {
                this.bindEvents();
                this.showScene('intro');
            }

            bindEvents() {
                const csvFileInput = document.getElementById('csvFileInput');
                csvFileInput.addEventListener('change', (event) => this.loadCSV(event));
                document.querySelector('.upload-label').addEventListener('click', () => csvFileInput.click());
            }

            async loadCSV(event) {
                const file = event.target.files[0];
                if (!file) return;

                const arrayBuffer = await file.arrayBuffer();
                const decoder = new TextDecoder('shift_jis');
                const text = decoder.decode(arrayBuffer);
                this.parseCSV(text);
            }

            parseCSV(text) {
                const rows = text.trim().split('\n');
                this.state.documents = [];
                this.state.currentDocumentIndex = 0; // Reset document index
                rows.forEach((row, index) => {
                    if (index === 0) return; // Skip header
                    const columns = row.split(',');
                    const item = columns[0].trim();
                    const amount = columns[1] ? columns[1].trim() : "0";
                    this.state.documents.push({ item, amount });
                });
                this.displayData();
                this.showScene('preparation');
            }

            displayData() {
                const dataDetails = document.getElementById('dataDetails');
                dataDetails.innerHTML = this.state.documents.map(doc => `<div>${doc.item}: ${doc.amount} 円</div>`).join('');
                document.getElementById('csvFileInput').style.display = 'none';
                document.querySelector('.upload-label').style.display = 'none';
            }

            formatText(text) {
                const currentDoc = this.state.documents[this.state.currentDocumentIndex];
                const documentsList = this.state.documents.map(doc => doc.item).join(", ");
                return text.replace(/{documents}/g, documentsList)
                           .replace(/{currentItem}/g, currentDoc ? currentDoc.item : "")
                           .replace(/{currentAmount}/g, currentDoc ? currentDoc.amount : "")
                           .replace(/{trust}/g, this.state.trust);
            }

            async typeText(text) {
                const textContent = document.getElementById('textContent');
                textContent.innerHTML = '';

                const formattedText = this.formatText(text);
                for (let char of formattedText) {
                    textContent.innerHTML += char;
                    await new Promise(resolve => setTimeout(resolve, this.state.textSpeed));
                }
            }

            async showScene(sceneKey) {
                const scene = this.scenes[sceneKey];
                this.state.currentScene = sceneKey;

                if (scene.image) {
                    document.getElementById('sceneImage').querySelector('img').src = scene.image;
                }

                if (scene.text) {
                    await this.typeText(scene.text);
                } else {
                    document.getElementById('textContent').innerHTML = '';
                }

                this.updateStatus();

                if (scene.choices) {
                    this.showChoices(scene.choices);
                } else if (scene.next) {
                    if (scene.next === 'checkNextDocument') {
                        this.checkNextDocument();
                    } else {
                        this.showScene(scene.next);
                    }
                } else {
                    this.showChoices([]); // 選択肢をクリア
                }
            }

            updateStatus() {
                document.getElementById('trustValue').innerText = this.state.trust;
                document.getElementById('stressValue').innerText = this.state.stress;
            }

            showChoices(choices) {
                const choicesContainer = document.getElementById('choices');
                choicesContainer.innerHTML = '';
                choices.forEach(choice => {
                    const choiceElement = document.createElement('div');
                    choiceElement.className = 'choice';
                    choiceElement.innerText = choice.text;
                    choiceElement.addEventListener('click', () => {
                        if (choice.action === 'resetGame') {
                            this.resetGame();
                        } else {
                            this.selectChoice(choice);
                        }
                    });
                    choicesContainer.appendChild(choiceElement);
                });
            }

            selectChoice(choice) {
                if (choice.trust !== undefined) {
                    this.state.trust += choice.trust;
                }
                if (choice.stress !== undefined) {
                    this.state.stress += choice.stress;
                }

                if (choice.next) {
                    this.showScene(choice.next);
                } else {
                    this.showScene('end');
                }
            }

            checkNextDocument() {
                this.state.currentDocumentIndex++;
                if (this.state.currentDocumentIndex < this.state.documents.length) {
                    this.showScene('documentReview');
                } else {
                    this.showScene('end');
                }
            }

            resetGame() {
                // Reset game state
                this.state = { ...this.initialState };
                document.getElementById('dataDetails').innerHTML = '';
                document.getElementById('csvFileInput').style.display = 'inline';
                document.querySelector('.upload-label').style.display = 'inline-block';

                // ファイル入力要素の値をリセット
                document.getElementById('csvFileInput').value = '';

                // イベントリスナーを再バインド
                this.bindEvents();

                this.showScene('intro');
            }
        }

        window.onload = () => new RetroGame();
    </script>
</body>
</html>
